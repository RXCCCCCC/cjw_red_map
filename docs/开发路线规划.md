# 程家湾红色资源数字地图 — 开发路线规划

## 一、项目概述

基于无人机倾斜摄影生成的 3D Tiles 1.1 模型数据，结合腾讯地图/CesiumJS，制作程家湾红色资源数字地图（H5 可交互页面）。涵盖红军医院、炮台、红军路等红色遗址的坐标标注、三维模型浏览、语音导览、历史图文与口述历史音频等功能。

## 二、技术栈

| 层级 | 技术 | 说明 |
|------|------|------|
| 前端框架 | Vue 3 + Vite | SFC + Composition API |
| 状态管理 | Pinia | 轻量级状态管理 |
| UI 组件库 | Vant 4 | 移动端 H5 组件库 |
| CSS 框架 | Tailwind CSS | 原子化 CSS |
| 3D 渲染 | CesiumJS | 加载 3D Tiles 1.1 模型 |
| 2D 地图 | 腾讯地图 JS API / Leaflet | POI 标注与底图 |
| 后端框架 | Flask | 轻量 Python Web 框架 |
| ORM | SQLAlchemy + PyMySQL | 数据库操作 |
| 数据库 | MySQL | 存储遗址、媒体、导览数据 |
| 静态资源 | Flask 静态文件服务 | 3D Tiles / 图片 / 音频 |

## 三、项目目录结构

```
cjw_red_map/
├── 开发路线规划.md              # 本文件
├── 程家湾地图开发随记.md         # 任务描述
├── out/                         # 3D Tiles 1.1 原始数据 (GISBox 输出)
│   ├── tileset.json
│   └── Block***/ ...
│
├── backend/                     # Flask 后端
│   ├── app/
│   │   ├── __init__.py          # Flask App 工厂
│   │   ├── config.py            # 配置文件
│   │   ├── models.py            # SQLAlchemy 数据模型
│   │   ├── routes/
│   │   │   ├── __init__.py
│   │   │   ├── site.py          # 遗址 CRUD API
│   │   │   ├── media.py         # 媒体资源 API
│   │   │   └── audio_guide.py   # 语音导览 API
│   │   ├── seeds.py             # 数据库初始化种子数据
│   │   └── utils.py             # 工具函数
│   ├── requirements.txt
│   ├── run.py                   # 启动入口
│   └── init_db.py               # 数据库初始化脚本
│
├── frontend/                    # Vue 3 前端
│   ├── index.html
│   ├── package.json
│   ├── vite.config.js
│   ├── tailwind.config.js
│   ├── postcss.config.js
│   ├── public/
│   │   └── favicon.ico
│   ├── src/
│   │   ├── main.js
│   │   ├── App.vue
│   │   ├── router/
│   │   │   └── index.js
│   │   ├── stores/
│   │   │   ├── site.js          # 遗址数据 store
│   │   │   └── audio.js         # 音频播放 store
│   │   ├── views/
│   │   │   ├── HomeView.vue     # 首页/启动页
│   │   │   ├── MapView.vue      # 2D 地图页 (POI 标注)
│   │   │   ├── Model3DView.vue  # 3D 模型浏览页
│   │   │   ├── SiteDetail.vue   # 遗址详情页
│   │   │   └── AboutView.vue    # 项目介绍页
│   │   ├── components/
│   │   │   ├── SiteCard.vue     # 遗址卡片
│   │   │   ├── AudioPlayer.vue  # 音频播放器
│   │   │   ├── MapContainer.vue # 地图容器
│   │   │   ├── CesiumViewer.vue # Cesium 3D 查看器
│   │   │   ├── NavBar.vue       # 导航栏
│   │   │   └── SitePopup.vue    # 遗址弹窗
│   │   ├── assets/
│   │   │   ├── images/          # 历史图片
│   │   │   └── audio/           # 语音导览音频
│   │   ├── api/
│   │   │   └── index.js         # Axios API 封装
│   │   └── styles/
│   │       └── main.css         # 全局样式 + Tailwind 指令
│   └── .env
```

## 四、数据库设计

### 4.1 sites — 红色遗址表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT, PK, AUTO | 主键 |
| name | VARCHAR(100) | 遗址名称 |
| description | TEXT | 遗址简介 |
| longitude | DOUBLE | 经度 (WGS84) |
| latitude | DOUBLE | 纬度 (WGS84) |
| category | VARCHAR(50) | 分类 (医院/炮台/道路等) |
| icon | VARCHAR(200) | 地图图标 URL |
| cover_image | VARCHAR(200) | 封面图 URL |
| sort_order | INT | 排序权重 |
| created_at | DATETIME | 创建时间 |

### 4.2 media — 媒体资源表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT, PK, AUTO | 主键 |
| site_id | INT, FK → sites.id | 关联遗址 |
| type | ENUM('image','audio','video') | 媒体类型 |
| url | VARCHAR(300) | 资源路径 |
| title | VARCHAR(200) | 标题 |
| description | TEXT | 描述 |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |

### 4.3 audio_guides — 语音导览表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT, PK, AUTO | 主键 |
| site_id | INT, FK → sites.id | 关联遗址 |
| title | VARCHAR(200) | 导览标题 |
| audio_url | VARCHAR(300) | 音频路径 |
| transcript | TEXT | 文字稿 |
| duration | INT | 时长 (秒) |
| sort_order | INT | 排序 |
| created_at | DATETIME | 创建时间 |

## 五、API 接口设计

### 5.1 遗址接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/sites | 获取全部遗址列表 |
| GET | /api/sites/:id | 获取单个遗址详情 |
| POST | /api/sites | 新增遗址 |
| PUT | /api/sites/:id | 更新遗址 |
| DELETE | /api/sites/:id | 删除遗址 |

### 5.2 媒体接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/sites/:id/media | 获取遗址媒体列表 |
| POST | /api/media | 上传媒体资源 |
| DELETE | /api/media/:id | 删除媒体资源 |

### 5.3 语音导览接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/sites/:id/audio-guides | 获取遗址语音导览 |
| POST | /api/audio-guides | 新增语音导览 |
| DELETE | /api/audio-guides/:id | 删除语音导览 |

### 5.4 3D Tiles 服务

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /tiles/* | 静态代理 out/ 目录下的 3D Tiles 文件 |

## 六、开发步骤 (里程碑)

### 第一阶段：项目初始化 ✅
1. 创建后端 Flask 项目骨架，安装依赖
2. 创建前端 Vue 3 + Vite 项目，安装 Vant / Tailwind / Pinia / CesiumJS
3. 配置 Vite 开发代理 → Flask 后端

### 第二阶段：数据层 ✅
4. 编写 SQLAlchemy 模型 (sites, media, audio_guides)
5. 编写数据库初始化脚本 + 种子数据 (红军医院 / 炮台 / 红军路坐标)
6. 创建 Flask RESTful API 路由

### 第三阶段：前端核心页面 ✅
7. 首页（启动页 + 导航入口）
8. 2D 地图页 — Leaflet 加载天地图底图 + POI 标注 + 点击弹窗
9. 3D 模型浏览页 — CesiumJS 加载 out/ 3D Tiles 模型
10. 遗址详情页 — 图文展示 + 音频播放器 + 语音导览

### 第四阶段：交互增强 ✅
11. 音频播放器组件 (AudioPlayer.vue) — 播放/暂停/进度条
12. 地图 ↔ 详情页联动跳转
13. 3D 模型视角飞行到指定遗址

### 第五阶段：优化与部署
14. 移动端适配 (vw/vh + Vant 响应式)
15. 3D Tiles 加载性能优化
16. 打包部署说明

## 七、遗址种子数据 (预置)

根据 3D Tiles transform 矩阵反算，程家湾大致位于 **江西省上饶市横峰县** 附近 (约 28.8°N, 117.9°E)。以下为预置 POI：

| 名称 | 经度 | 纬度 | 分类 |
|------|------|------|------|
| 红军医院旧址 | 117.8960 | 28.8150 | 医院 |
| 红军炮台 | 117.8975 | 28.8140 | 军事设施 |
| 红军路 | 117.8950 | 28.8165 | 道路 |
| 程家湾村口 | 117.8940 | 28.8155 | 地标 |

> 注：以上坐标为估算值，实地测绘后需替换为实际 GPS 坐标。

## 八、启动方式

### 后端
```bash
cd backend
pip install -r requirements.txt
python init_db.py    # 初始化数据库 + 种子数据
python run.py        # 启动 Flask (默认 :5000)
```

### 前端
```bash
cd frontend
npm install
npm run dev          # 启动 Vite 开发服务器 (默认 :5173)
```

### 访问
- 前端页面: http://localhost:5173
- 后端 API: http://localhost:5000/api
- 3D Tiles: http://localhost:5000/tiles/tileset.json
