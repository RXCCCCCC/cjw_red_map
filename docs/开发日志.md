# 程家湾红色资源数字地图 — 开发日志

---

## 2026-02-14 引入 .env 环境变量管理敏感配置

### 背景
之前的修复中，将 MySQL 密码直接硬编码在 `config.py` 中（`DB_PASSWORD = '061128aA'`），这存在严重的安全隐患：
- 密码泄露风险：如果提交到 GitHub，密码会暴露在公开仓库中
- 协作困难：每个开发者的 MySQL 密码不同，频繁修改 `config.py` 会产生 Git 冲突
- 不符合最佳实践：敏感信息应通过环境变量管理，不应硬编码

### 解决方案
引入 `python-dotenv` 库，通过 `.env` 文件管理敏感配置：

**1. 创建文件**
- `backend/.env.example` — 示例配置文件（提交到 Git，不含真实密码）
- `backend/.env` — 实际配置文件（不提交，包含真实密码）

**2. 修改 `config.py`**
- 自动从 `backend/.env` 加载环境变量
- 如果 `DB_PASSWORD` 未配置，抛出明确错误提示用户创建 `.env` 文件
- 移除硬编码的密码

**3. 更新 `requirements.txt`**
- 添加 `python-dotenv==1.0.1` 依赖

**4. 更新 `.gitignore`**
- 确认 `.env` 已被忽略（已有规则，添加注释说明）

**5. 更新 `README.md`**
- 新增"使用 .env 文件（推荐）"配置方式
- 更新部署流程：`cp .env.example .env` → 编辑密码 → 启动

### 技术要点
- **python-dotenv**：自动从 `.env` 文件加载环境变量到 `os.environ`
- **向后兼容**：如果未安装 `python-dotenv`，会提示但不会阻止程序运行（可通过系统环境变量配置）
- **错误检查**：启动时检查 `DB_PASSWORD` 是否为空，避免运行时才报认证错误

### 使用方法
```bash
cd backend
cp .env.example .env
# 编辑 .env，修改 DB_PASSWORD=你的MySQL密码
pip install -r requirements.txt  # 安装 python-dotenv
python run.py
```

### 经验教训
- ✅ 敏感配置必须通过 `.env` 或环境变量管理，绝不硬编码
- ✅ 提供 `.env.example` 作为模板，方便新开发者快速配置
- ✅ 在 `config.py` 中加入检查逻辑，给出清晰的错误提示

---

## 2026-02-14 修复 API 500 错误（MySQL 密码配置）并重写 README

### 问题现象
前端控制台报 `500 (INTERNAL SERVER ERROR)`，`/api/sites` 返回失败，地图上没有任何地标。

### 根因分析
`backend/app/config.py` 中 `DB_PASSWORD` 默认值（`123456`）与本地 MySQL 实际密码不匹配，导致 PyMySQL 认证失败：
```
pymysql.err.OperationalError: (1045, "Access denied for user 'root'@'localhost' (using password: YES)")
```

### 修复
- 将 `config.py` 中 `DB_PASSWORD` 默认值改为本机正确密码。
- 重新验证：`/api/sites` 返回 `code: 0`，8 个地标、10 条媒体正常加载。

### README 重写
- 新增完整目录结构树、技术栈表格、API 概览表。
- 新增"MySQL 配置"独立章节，提示每个部署者必须修改密码。
- 新增"他人从 GitHub 克隆后能否看到完全一样的效果？"专题说明。
- 新增 `.gitignore` 建议和生产环境部署建议。

### 经验教训
- **安全**：不要在公开仓库中硬编码真实数据库密码。README 中应使用占位符（`你的MySQL密码`），并提醒开发者通过环境变量或本地 config 文件配置。
- **排查**：后端 500 错误首先检查数据库连接（密码、主机、端口、服务是否启动），再检查路由逻辑。

---

## 2026-02-14 创建一键数据同步工具 sync_seeds.py

### 背景
项目使用 MySQL 数据库，通过编辑模式修改的地标坐标、封面图片、媒体资源等数据保存在本地数据库中。  
但他人部署时依赖 `init_db.py` + `seeds.py` 来初始化数据，而 `seeds.py` 不会自动更新，导致 GitHub 上的数据与本地不一致。  
**之前的做法**：需要手动运行 `sync_data.py` 导出数据，再人工复制粘贴到 `seeds.py`，非常容易遗漏。

### 解决方案
创建 `backend/sync_seeds.py` 脚本，一键完成数据库→`seeds.py` 的自动同步。

**工作原理**：
1. 读取 MySQL 中所有 Site、Media、AudioGuide 数据  
2. 自动生成格式化的 `seeds.py` 文件内容  
3. 对比现有文件，如有变化则覆盖写入  
4. 只导出有实际文件的媒体记录（跳过空 URL 的占位记录）

**使用方法（每次修改数据后）**：
```bash
cd backend
python sync_seeds.py       # 自动重写 seeds.py
git add app/seeds.py uploads/
git commit -m "同步地标数据"
git push
```

### 技术要点
- 描述文本自动按句号/逗号折行（每行不超过 72 字符），保持代码可读性
- 经纬度保留 8 位小数，高度保留 4 位小数，确保坐标精度
- 媒体记录按 `site_id → sort_order` 排序，保证数据顺序稳定
- 生成前对比旧文件，无变化时跳过写入，避免无效 diff
- 删除了旧的 `sync_data.py`（只输出不写入，需要手动复制，已被 `sync_seeds.py` 取代）

---

## 2026-02-13 地标标注样式二次优化

### 背景
上一轮优化后，地标标签的字体和描边在某些视角下略显模糊，且光晕底座不够明显。用户希望进一步提升清晰度并扩大底座范围。

### 变更内容

#### 1. 字体清晰度提升
- **字号加大**：从 `14px` 提升至 `18px`
- **字重加粗**：从 `bold` (700) 提升至 `900`（最粗），增强可读性
- **描边优化**：`outlineWidth` 从 `1` 增加到 `3`，颜色从 `BLACK` (alpha 0.6) 调整为 `BLACK` (alpha 0.8)，增强文字与背景的对比度，解决"糊"的问题

#### 2. 光晕底座扩大
- **半径**：半长轴/半短轴从 `3.5` 扩大至 `8.0`（面积增加约 5 倍）
- **透明度**：从 `0.18` 提升至 `0.25`，使其在深色背景下更具辨识度

### 效果预期
- 标签文字在 3D 场景中将更加锐利和醒目
- 红色光晕范围显著增大，使地标点在远景下更容易被发现

---

## 2026-02-13 地标标注样式美化

### 背景
地图中各地标点的标注样式较为粗糙，红色背景标签上显示了经度、纬度、高度等坐标信息，信息冗余且影响美观（如截图所示）。用户希望只保留地标名称，并优化整体视觉效果。

### 变更内容

#### 1. 标签文本精简
移除标签中的经纬度和海拔高度信息，只保留地标名称。涉及三处文本设置：
- **`addSiteMarker()`**：创建地标时的初始标签文本
- **拖动事件 `MOUSE_MOVE`**：拖动调整位置时的实时标签更新
- **`submitEditSite()`**：编辑保存后的标签同步更新

#### 2. 视觉样式优化
| 属性 | 旧值 | 新值 |
|------|------|------|
| 标签字体 | `bold 13px sans-serif` | `bold 14px "Microsoft YaHei", "PingFang SC", sans-serif` |
| 背景色 | `#C41E24` alpha 0.85 | `#B91C1C` alpha 0.92（更深沉的红色） |
| 背景内边距 | `8, 4` | `12, 6`（更宽松舒适） |
| 文字描边 | 红色描边 2px | 黑色半透明描边 1px（更清晰） |
| 标签水平对齐 | 未设置 | `CENTER`（居中于标注点上方） |
| 点大小 | 14px | 10px（更精致） |
| 点描边宽度 | 2px | 3px（白色外圈更醒目） |
| 远近缩放 | 无 | `NearFarScalar(100, 1.4, 5000, 0.6)`（近大远小） |

#### 3. 新增外圈光晕效果
为每个地标新增一个半透明红色椭圆底座（`ellipse`），半径 3.5 米、透明度 0.18，使地标点在地图上更加醒目且有层次感。

### 技术要点
- 仅修改前端 `CesiumViewer.vue`，不涉及后端或数据库变更
- 坐标信息仍保留在弹窗详情中，用户点击地标后依然可以查看
- `scaleByDistance` 实现了根据视距自动缩放的效果，近景放大显示、远景缩小避免遮挡

---

## 2026-02-14 解决数据同步问题（地标位置与图片）

### 背景
项目上传到 GitHub 后，发现他人部署时遇到两个关键问题：
1. **地标位置不一致**：别人看到的地标坐标与本地不同
2. **图片无法显示**：详情页的地标封面和媒体图片加载失败

### 原因分析

#### 问题 1：地标坐标不同步
- **根本原因**：通过编辑模式修改的地标坐标只保存在本地 MySQL 数据库，未同步到 `seeds.py`
- **影响范围**：8 个地标中有 5 个坐标被精细调整（例如：纪念馆从 `117.88045` 调整为 `117.88044967`）
- **他人部署**：运行 `init_db.py` 时使用的是 `seeds.py` 中的旧坐标

#### 问题 2：图片文件缺失
- **根本原因**：`backend/uploads/` 目录被 `.gitignore` 忽略，未提交到 GitHub
- **影响范围**：15 个图片文件（占用约 2-3MB），包括 5 个封面图和 10 个媒体图片
- **他人部署**：数据库中保存了图片路径（如 `/uploads/20260213133748_50216999.jpg`），但文件不存在

### 解决方案

#### 1. 创建数据同步工具（`backend/sync_data.py`）

新增脚本，实现以下功能：
- 从当前数据库导出所有地标数据（坐标、描述、分类、图片路径等）
- 自动生成可直接复制到 `seeds.py` 的 Python 代码
- 列出所有需要同步的图片文件清单
- 检查数据库引用的文件是否全部存在

**使用方法**：
```bash
cd backend
python sync_data.py  # 导出数据并生成报告
```

#### 2. 更新种子数据（`backend/app/seeds.py`）

使用 `sync_data.py` 导出的最新数据替换了原有的 `sites_data`：
- 更新了所有 7 个地标的精确坐标（保留到小数点后 5-8 位）
- 补充了封面图片路径（5 个地标有封面）
- 同步了编辑后的描述文本

**关键变化示例**：
| 地标 | 旧坐标（seeds.py） | 新坐标（实际数据库） |
|------|-------------------|---------------------|
| 纪念馆 | 117.88045, 28.92844 | 117.88044967, 28.92843615 |
| 老人们的家 | 117.88210, 28.92944 | 117.88209415, 28.92901258 |
| 胜利之门 | 117.88045, 28.92801 | 117.88075000, 28.92838000 |

#### 3. 图片文件同步方案

创建了详细的图片同步文档（`docs/图片同步方案.md`），提供 3 种方案：

**方案一（推荐生产环境）**：对象存储（OSS/COS）
- 将 `uploads/` 下的 15 个文件上传到云存储
- 修改数据库中的路径为 CDN 地址
- 优点：专业、稳定、不占仓库空间

**方案二（推荐开源项目）**：Git LFS
- 使用 Git Large File Storage 管理图片
- 图片与代码版本化，但不占主仓库空间
- 优点：开源友好，免费额度 1GB/月

**方案三（当前采用）**：直接提交到仓库
- 修改 `.gitignore`，允许提交 `uploads/` 目录
- 优点：简单直接，适合小项目演示
- 缺点：会增大仓库体积（当前 15 个文件约 2-3MB，可接受）

#### 4. 修改 .gitignore

将 `backend/uploads/` 一行注释掉，允许图片文件被提交：
```gitignore
# backend/uploads/  # 注释掉以允许提交图片（临时方案）
# 生产环境建议使用对象存储（OSS/COS）托管图片，详见 docs/图片同步方案.md
```

#### 5. 更新 README 部署文档

新增"数据同步"章节，明确说明：
- 数据同步的必要性和方法
- 图片同步的两种方案（临时 vs 生产）
- 同步工具的使用流程

### 技术要点

**数据导出脚本亮点**：
- 自动格式化描述文本（按 70 字符折行，保持 Python 代码可读性）
- 扫描数据库引用的所有文件，生成完整清单
- 检查文件完整性，识别缺失文件

**部署一致性保证**：
- `seeds.py` 现在包含完整的坐标和图片路径信息
- 他人运行 `init_db.py` 后，地标位置与原作者一致
- `uploads/` 目录提交后，图片可正常加载

### 使用流程

**项目维护者（数据有更新时）**：
```bash
# 1. 导出最新数据
cd backend
python sync_data.py

# 2. 复制输出的 sites_data，替换 seeds.py 中的对应部分

# 3. 提交更改
git add backend/app/seeds.py backend/uploads/
git commit -m "同步地标数据和图片"
git push
```

**他人部署**：
```bash
git clone https://github.com/your-repo/cjw-red-map.git
cd cjw-red-map/backend
python init_db.py  # 自动获得最新的坐标和图片路径
# uploads/ 目录中的图片文件已随仓库一起克隆
```

### 遗留问题

- **重复地标**：数据库中存在 2 个"程家湾广场"（ID 6 和 7），需要后续清理
- **对象存储迁移**：当前使用临时方案将图片提交到 GitHub，长期建议迁移到 OSS

---

## 2026-02-13 完善数据库分发方案

### 背景
为了便于项目在 GitHub 上开源分享，以及他人快速部署，需要提供完整的数据库初始化和备份/还原方案。

### 变更内容

#### 1. 完善种子数据（`backend/app/seeds.py`）
将数据库中的所有 7 个红色地标数据补充到种子脚本中：

| 地标名称 | 分类 | 坐标 |
|---------|------|------|
| 纪念馆 | 纪念设施 | 117.88045, 28.92844, 175.0m |
| 程家湾老人们的家 | 居民生活 | 117.88210, 28.92944, 171.4m |
| 碉堡 | 军事遗址 | 117.88235, 28.92964, 174.9m |
| 炮台 | 军事遗址 | 117.88170, 28.92695, 219.5m |
| 程家湾突围指挥部 | 革命旧址 | 117.88075, 28.92838, 215.4m |
| 胜利之门 | 纪念设施 | 117.88045, 28.92801, 171.4m |
| 程家湾广场 | 公共设施 | 117.68216, 28.92739, 229.8m |

每个地标都包含：名称、详细描述、经纬度坐标、海拔高度、分类标签。

#### 2. 创建数据库导出工具（`backend/export_db.py`）
新增 SQL 导出脚本，提供两种数据库分发方式：

**方式一（推荐）**：`python init_db.py`
- 跨平台，不依赖 mysqldump
- 数据结构清晰，易于维护和定制
- 他人克隆仓库后直接运行即可初始化

**方式二（可选）**：`python export_db.py`
- 导出完整 SQL 文件（包含表结构和数据）
- 适用于数据迁移或备份场景
- 生成带时间戳的备份文件

#### 3. 更新 README.md 部署文档
新增详细的部署指南：
- **前置要求**：Node.js、Python、MySQL 版本要求
- **环境配置**：数据库连接配置（代码修改 vs 环境变量）
- **数据库管理**：两种初始化方式的使用说明
- **GitHub 部署流程**：需要上传的文件、.gitignore 配置、他人克隆部署步骤
- **生产环境建议**：云数据库、HTTPS、对象存储、进程管理

#### 4. 完善 .gitignore
添加规则防止误提交敏感文件：
- `*.sql`、`database_backup*.sql`：数据库备份文件
- `backend/app/config_local.py`：本地配置覆盖文件
- 保留白名单 `!backend/schema.sql`（如果需要版本化表结构）

### 技术要点
- **SQLAlchemy ORM**：`init_db.py` 通过 ORM 自动创建表结构，比 SQL 文件更易维护
- **跨平台兼容**：环境变量方式支持 Windows/Linux/Mac
- **安全性**：README 强调不要硬编码密码，生产环境使用环境变量
- **文件体积**：3D Tiles 等大文件建议用 Git LFS 或对象存储

### 使用流程

**项目维护者（你）**：
```bash
# 如果修改了数据模型，更新 seeds.py 并提交
git add backend/app/seeds.py backend/init_db.py
git commit -m "更新种子数据"
git push
```

**他人部署**：
```bash
git clone https://github.com/your-repo/cjw-red-map.git
cd cjw-red-map/backend
# 修改 config.py 中的数据库密码
python init_db.py  # 一键初始化数据库
python run.py      # 启动后端
```

---

## 2026-02-13 地标标注圆角化改造

### 背景
用户希望地标标注的背景框具有圆角效果，且边框范围更大。由于 Cesium 原生 `LabelGraphics` 不支持圆角背景（`showBackground` 只能是矩形），因此需要采用 Canvas 自定义绘制生成图片，并改用 `BillboardGraphics` 进行渲染。

### 变更内容

#### 1. 渲染方式重构
- **Label → Billboard**：移除了原有的 `label` 实体组件，改为 `billboard` 组件。
- **动态 Canvas 生成**：新增 `createSiteLabelCanvas(text)` 工具函数，使用 HTML5 Canvas API 动态绘制包含文字和圆角背景的图像。

#### 2. 样式升级
- **大圆角背景**：绘制圆角半径为 `20px` 的矩形，背景色保留深红 `#B91C1C` (Alpha 0.95)。
- **内边距扩大**：水平内边距增加到 `32px`，垂直内边距增加到 `16px`，满足“边框改大”的需求。
- **超清渲染**：Canvas 绘图字号设为 `32px`（比实际显示大），Billboard 缩放比例设为 `0.5`，确保在高分屏下文字边缘依然清晰锐利。

#### 3. 逻辑适配
- **Entity 更新逻辑**：在 `submitEditSite` 中，当地标名称修改后，不再设置 `label.text`，而是调用 `createSiteLabelCanvas` 重新生成图片并赋值给 `billboard.image`。
- **拖动交互优化**：清理了拖动事件中尝试更新 `label.text` 的废弃代码。

### 技术要点
- **Canvas 绘图**：使用 `quadraticCurveTo` 绘制平滑圆角，避免兼容性问题。
- **性能优化**：Canvas 仅在地标创建或名称修改时生成一次，后续渲染直接使用纹理，性能损耗可控。
- **缩放策略**：保留了 `scaleByDistance` 配置，确保近大远小的视觉体验与之前保持一致。

---

## 2026-02-13 术语统一 & 地标描述补充

### 背景
项目最初将所有标记点统称为"遗址"（`遗址`），但随着实际标注越来越多，发现标记点涵盖纪念设施（纪念馆、胜利之门）、军事遗址（碉堡、炮台）、革命旧址（突围指挥部）、居民生活区（老人们的家）、公共设施（广场）等多种类型，"遗址"这一用词不够准确。

### 变更内容

#### 1. 术语替换："遗址" → "地标"
在全项目范围内将用户可见的"遗址"描述统一替换为"地标"（红色地标），涵盖以下文件：

| 文件 | 改动 |
|------|------|
| `backend/app/models.py` | 类注释、字段 comment |
| `backend/app/routes/site.py` | 路由函数注释 |
| `backend/app/seeds.py` | 文件头注释、打印日志 |
| `frontend/src/api/index.js` | 注释 |
| `frontend/src/router/index.js` | 路由 meta.title |
| `frontend/src/views/SiteDetail.vue` | NavBar title、section 标题 |
| `frontend/src/views/MapView.vue` | 列表标题、注释 |
| `frontend/src/views/HomeView.vue` | 入口卡片文字 |
| `frontend/src/views/AboutView.vue` | 项目简介文案 |
| `frontend/src/components/CesiumViewer.vue` | 全部 UI 文字、注释、日志 |

> **注意**：`docs/` 下的早期规划文档（`开发路线规划.md`、`程家湾地图开发随记.md`）保留原始"遗址"用词作为历史记录，未做修改。

#### 2. 地标分类与描述补充
通过 API 为数据库中缺少描述的 7 个地标补充了贴合红色资源主题的分类（`category`）和描述（`description`）：

| ID | 名称 | 分类 | 描述摘要 |
|----|------|------|----------|
| 1 | 纪念馆 | 纪念设施 | 已有描述，未修改 |
| 2 | 程家湾老人们的家 | 居民生活 | 赣东北传统民居，革命年代掩护红军伤员… |
| 3 | 碉堡 | 军事遗址 | 制高点防御工事，石头泥土堆砌，扣眼朗朵… |
| 4 | 炮台 | 军事遗址 | 山顶火炮阵地，与碉堡遥相呼应… |
| 5 | 程家湾突围指挥部 | 革命旧址 | 闽浙赣省委核心指挥中心，制定突围计划… |
| 6 | 胜利之门 | 纪念设施 | 纪念突围战胜利的标志性建筑… |
| 7 | 程家湾广场 | 公共设施 | 村中集会区，红色教育活动场所… |
| 8 | 程家湾广场 | 公共设施 | 同上（重复记录） |

### 技术要点
- 术语替换仅影响 UI 展示文本和代码注释，**不涉及数据库表结构或 API 路径的变更**（`/api/sites` 路径保持不变）
- 描述信息通过 `PUT /api/sites/:id` 接口写入 MySQL，永久生效
- 分类（`category`）字段现有值：`纪念设施`、`军事遗址`、`革命旧址`、`居民生活`、`公共设施`

---

## 2026-02-14 整理项目架构并更新 README

### 背景
为了帮助新贡献者快速上手并减少部署差异，整理并补充了仓库级别的架构说明、关键文件说明、快速启动与验证步骤，并在 README 中加入了数据同步的推荐流程（含 `sync_seeds.py` 与 `export_db.py` 使用说明）。

### 变更内容
- 更新 `README.md`：添加项目概览、关键文件映射、快速启动命令、数据同步流程和验证步骤。
- 建议工作流：使用 `sync_seeds.py` 生成/更新 `backend/app/seeds.py`，媒体文件长期存储建议迁移到对象存储（OSS/COS/S3）。

### 操作记录
```bash
cd backend
python sync_seeds.py    # 从本地 DB 生成并更新 app/seeds.py（如有改动）
git add app/seeds.py
git add backend/uploads/ # 若采用直接提交图片
git commit -m "doc(readme): 更新 README 与数据同步说明"
git push
```

### 注意点
- `init_db.py` 仍然是破坏性重建脚本（会 drop_all 并重建表），请在运行前备份数据库或使用 `export_db.py` 生成 SQL 快照。
- 长期建议：建立 CI 自动化备份（merge 到 main 时自动生成 `.sql` 并上传到私有存储或 release artifact）。

---

## 2026-02-16 前端体验优化：进度条平滑、星星光效、离页停播、地标列表

### 改动概述
集中修复和优化了 4 个前端交互问题。

### 1. 进度条平滑更新
**问题**：原方案使用 HTML5 Audio 的 `timeupdate` 事件（约 250ms 触发一次），导致进度条视觉上一卡一卡。
**方案**：改用 `requestAnimationFrame` 循环读取 `currentTime`，约 16ms 更新一次，进度条过渡更丝滑。
- 文件：`frontend/src/stores/audio.js`
- 移除 `timeupdate` 监听，新增 `startRaf()` / `stopRaf()` 函数

### 2. 黄星动态光效与拖影
**变更**：进度条指示器从红色星 ★ 改为金黄色 ★，播放中有脉冲光效和向左扩散的多层拖影。
- 文件：`frontend/src/components/AudioPlayer.vue`
- 使用 CSS `@keyframes starGlow` 实现呼吸式缩放 + 多层 `drop-shadow`
- 仅 `.is-playing` 状态时触发动画，静止时只有基础光晕

### 3. 离开页面时停止音频
**问题**：从地标详情页导航回主页后，语音解说仍在后台播放。
**方案**：在 `SiteDetail.vue` 添加 `onBeforeUnmount` 钩子调用 `audioStore.stop()`。`stop()` 是新增方法，会暂停、重置 `currentTime`、清除 `currentGuide`。
- 文件：`frontend/src/stores/audio.js` — 新增 `stop()` 方法
- 文件：`frontend/src/views/SiteDetail.vue` — `onBeforeUnmount(() => audioStore.stop())`

### 4. 地标列表页
**问题**：主页"地标详情"直接跳转到 `/site/1`，无法选择其他地标。
**方案**：新增 `SiteListView.vue` 列表页，展示所有地标（封面、名称、分类、简介），点击跳转详情。
- 新增：`frontend/src/views/SiteListView.vue`
- 路由：新增 `/sites` → `SiteListView`
- 主页链接从 `/site/1` 改为 `/sites`

---

## 2026-02-16 播放器优化：黄星红圈背景 + 音频真实时长

### 1. 黄星加红色圆圈背景
将进度条上的黄色星星指示器包裹在一个 26px 红色圆形背景中，视觉更醒目。
- 文件：`frontend/src/components/AudioPlayer.vue`
- 新增 `.star-circle` 样式类，`background: #C41E24`，圆角 50%

### 2. 音频时长改为真实时长
**问题**：未播放时显示的时长来自种子数据中的固定字段（如 `duration: 45`），与音频文件实际时长不符。
**方案**：组件挂载时通过 `new Audio()` 预加载音频元数据（`preload: 'metadata'`），从 `loadedmetadata` 事件获取真实时长。
- 优先级：正在播放时用 store 中的时长 → 预加载获取的真实时长 → 种子数据回退值

---

## 2026-02-16 路线颜色改为红色 + 完整数据导出

### 1. 路线颜色统一改为红色 (#C41E24)

**问题**：导航路线在 Cesium 地图上显示为蓝色（`CYAN`），与红色主题不协调。

**改动位置**：`frontend/src/components/CesiumViewer.vue`
- **导航高亮路线** `startNavigation()`：`Cesium.Color.CYAN` → `Cesium.Color.fromCssColorString('#C41E24')`
- **绘制临时线**（2处）：`Cesium.Color.YELLOW` → `Cesium.Color.fromCssColorString('#C41E24')`
- **保存路径默认色** `savePath()`：`line_color: '#FFFF00'` → `'#C41E24'`
- **渲染已有路径** `renderRoute()`：回退色从 `#FFFF00` → `'#C41E24'`
- **数据库**：已有 5 条路线的 `line_color` 字段均已更新为 `#C41E24`

### 2. 完整数据库导出为 SQL 文件

**目的**：让其他开发者部署项目时可直接导入全部数据（地标、媒体、语音导览、路线），无需逐个执行迁移脚本。

**输出文件**：`backend/migrations/full_data_dump.sql`

**包含内容**：
| 表 | 记录数 | 说明 |
|--|--|--|
| `sites` | 7 | 红色地标点（老人家、碉堡、炮台、指挥部、胜利之门、广场、纪念馆） |
| `media` | 10 | 图片资源（纪念馆 4 张、老人家 2 张、指挥部 4 张） |
| `audio_guides` | 7 | 语音导览（每个地标 1 条） |
| `routes` | 5 | 3D 漫游路径（红色 #C41E24） |

**使用方法**：
```bash
# 1. 创建数据库
mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS cjw_red_map CHARACTER SET utf8mb4;"

# 2. 导入完整数据
mysql -u root -p cjw_red_map < backend/migrations/full_data_dump.sql
```

**注意**：该文件包含 `DROP TABLE IF EXISTS`，执行后会**覆盖**已有数据。

---

## 2026-02-16 数据库迁移：routes 路径表 + audio_guides 数据更新

### 背景
需要将 `backend/migrations/` 下的两个 SQL 文件执行到 MySQL 数据库中，完成路径数据和音频导览数据的同步更新。

### 执行的操作

**1. 清空并重新插入 audio_guides 数据**
- 先 `DELETE FROM audio_guides` 清空旧数据（7 条），再插入新的 7 条记录
- 每条记录对应一个地标的语音解说：老人们的家、碉堡、炮台、指挥部、胜利之门、广场、纪念馆
- duration 字段值来自 SQL 文件中的设定值（12~20 秒不等）

**2. 重建 routes 表并插入 5 条游览路径**
- 执行 `create_routes_table.sql`：先 DROP 再 CREATE routes 表
- 插入 5 条路径数据：
  - 老人的家→纪念馆
  - 纪念馆→炮台
  - 纪念馆→碉堡
  - 纪念馆→指挥部
  - 纪念馆→程家湾广场
- 每条路径包含完整的 3D 坐标点数组（JSON 格式，含经度、纬度、高度）
- 线条颜色统一为黄色 `#FFFF00`，宽度 5

### 执行方式
- 编写临时 Python 脚本 `run_migrations.py`，使用 PyMySQL 直接连接数据库
- 自动处理 SQL 文件中的多行注释（`/* ... */`）和 `USE` 语句
- 执行完成后自动验证数据条数，确认无误后删除临时脚本

### 验证结果
- ✅ routes 表：5 条路径记录
- ✅ audio_guides 表：7 条音频导览记录
- ✅ 所有 site_id 正确对应 7 个地标

